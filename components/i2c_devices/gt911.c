/**
 * @file gt911.c
 * @brief GT911 Capacitive Touch Panel Controller Driver
 * @version 0.1
 * @date 2021-01-13
 * 
 * @copyright Copyright 2021 Espressif Systems (Shanghai) Co. Ltd.
 *
 *      Licensed under the Apache License, Version 2.0 (the "License");
 *      you may not use this file except in compliance with the License.
 *      You may obtain a copy of the License at
 *
 *               http://www.apache.org/licenses/LICENSE-2.0

 *      Unless required by applicable law or agreed to in writing, software
 *      distributed under the License is distributed on an "AS IS" BASIS,
 *      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *      See the License for the specific language governing permissions and
 *      limitations under the License.
 */

#include "gt911.h"

static const char *TAG = "gt911";

uint8_t CTP_CFG_GT911[184] =  {
    // 0x61,0xE0,0x01,0xE0,0x01,0x05,0x05,0x00,0x01,0x08,
    // 0x28,0x0F,0x50,0x32,0x03,0x05,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x8A,0x2A,0x0C,
    // 0x45,0x47,0x0C,0x08,0x00,0x00,0x00,0x02,0x02,0x2D,
    // 0x00,0x00,0x00,0x00,0x00,0x03,0x64,0x32,0x00,0x00,
    // 0x00,0x28,0x64,0x94,0xC5,0x02,0x07,0x00,0x00,0x04,
    // 0x9C,0x2C,0x00,0x8F,0x34,0x00,0x84,0x3F,0x00,0x7C,
    // 0x4C,0x00,0x77,0x5B,0x00,0x77,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x18,0x16,0x14,0x12,0x10,0x0E,0x0C,0x0A,
    // 0x08,0x06,0x04,0x02,0xFF,0xFF,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x16,0x18,0x1C,0x1D,0x1E,0x1F,0x20,0x21,
    // 0x22,0x24,0x13,0x12,0x10,0x0F,0x0A,0x08,0x06,0x04,
    // 0x02,0x00,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,

    // 0x61,0xE0,0x01,0xE0,0x01,0x05,0xB5,0x00,0x01,0x0F,
    // 0x14,0x0F,0x5F,0x32,0x03,0x05,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x18,0x1A,0x1C,0x14,0x89,0x29,0x0B,
    // 0x3A,0x38,0x8F,0x04,0x00,0x00,0x01,0x21,0x02,0x1D,
    // 0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x28,0x50,0x94,0xC5,0x02,0x08,0x00,0x00,0x04,
    // 0x80,0x2A,0x00,0x80,0x31,0x00,0x83,0x38,0x00,0x8C,
    // 0x41,0x00,0x9B,0x4A,0x00,0x9A,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x16,0x14,0x12,0x10,0x0E,0x0C,0x0A,0x08,
    // 0x06,0x04,0x02,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x02,0x04,0x06,0x08,0x0A,0x0F,0x10,
    // 0x12,0x16,0x18,0x1C,0x1D,0x1E,0x1F,0x20,0x21,0x22,
    // 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,

    // 0x61,0xE0,0x01,0xE0,0x01,
    // 0x05,0x04,0x10,0x01,0xC8,0x28,
    // 0x0F,0x50,0x32,0x03,0x05,0x00,0x00,0x00,0x00,0x11,
    // 0x11,0x05,0x18,0x1A,0x1E,0x14,0x88,0x29,0x0A,0x52,
    // 0x50,0x40,0x04,0x00,0x00,0x00,0x1A,0x32,0x1C,0x46,
    // 0x09,0x00,0x0F,0x00,0x2A,0xFF,0x7F,0x19,0x50,0x32,
    // 0x3C,0x64,0x94,0xD5,0x02,0x07,0x00,0x00,0x04,0x9F,
    // 0x3F,0x00,0x90,0x46,0x00,0x84,0x4D,0x00,0x79,0x55,
    // 0x00,0x6D,0x5F,0x00,0x6D,0x00,0x00,0x00,0x00,0xF0,
    // 0x4A,0x3A,0xFF,0xFF,0x27,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // 0x00,0x14,0x12,0x10,0x0E,0x0C,0x0A,0x08,0x06,0x04,
    // 0x02,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    // 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    // 0xFF,0x22,0x21,0x20,0x1F,0x1E,0x1D,0x1C,0x18,0x16,
    // 0x12,0x10,0x0F,0x08,0x06,0x04,0x02,0x00,0xFF,0xFF,
    // 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    // 0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
    // 0xFF,0xFF,0xFF,

    0x61,0xE0,0x01,0xE0,0x01,0x01,0x05,0x00,0x01,0x08,
    0x19,0x05,0x4A,0x3A,0x03,0x0F,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x18,0x1A,0x1E,0x14,0x89,0x2A,0x09,
    0x2F,0x2B,0x88,0x13,0x00,0x00,0x01,0xB8,0x03,0x2D,
    0x00,0x00,0x00,0x00,0x00,0x03,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x02,0x04,0x06,0x08,0x0A,0x0C,0x10,0x12,
    0x14,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x02,0x04,0x06,0x08,0x0A,0x0F,0x10,
    0x12,0x16,0x18,0x1C,0x1D,0x1E,0x1F,0x20,0x21,0x22,
    0x24,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,//0xF2,0x01 相对好一点
};
//https://github.com/xboot/xboot/pull/11/commits/b119553d16f6b260090f16436e250ff316a550a4

static i2c_bus_device_handle_t gt911_handle = NULL;

static esp_err_t gt911_read_bytes(uint16_t reg_addr, size_t data_len, uint8_t *data)
{
    return i2c_bus_read_reg16(gt911_handle, reg_addr, data_len, data);
}

static esp_err_t gt911_write_bytes(uint16_t reg_addr, size_t data_len, uint8_t *data)
{
    return i2c_bus_write_reg16(gt911_handle, reg_addr, data_len, data);
}

esp_err_t gt911_init(void)
{
    if (NULL != gt911_handle) {
        return ESP_FAIL;
    }

    bsp_i2c_add_device(&gt911_handle, GT911_ADDR);

    if (NULL == gt911_handle) {
        return ESP_FAIL;
    }

    uint8_t temp[5] = {0};
    gt911_read_bytes(GT_PID_REG, 4, temp); //read tp driver ic
    temp[4] = 0;
    ESP_LOGI(TAG, "tp driver ic:GT%s", temp);

    temp[0] = 0X02;
    gt911_write_bytes(GT_CTRL_REG, 1, temp);   //soft reset
    gt911_read_bytes(GT_CFGS_REG, 1, temp);    //read config version
    ESP_LOGI(TAG, "tp config version:0x%02X", temp[0]);
    if (temp[0] <= 0X61) // update the config
    {
        temp[0] = 0; temp[1] = 1;
        for (uint8_t i = 0; i < sizeof(CTP_CFG_GT911); i++)
            temp[0] += CTP_CFG_GT911[i]; // chksum
        temp[0] = (~temp[0]) + 1;
        ESP_LOGI(TAG, "run config:%d %02X %02X", sizeof(CTP_CFG_GT911), temp[0], temp[1]);
        gt911_write_bytes(GT_CFGS_REG, sizeof(CTP_CFG_GT911), (uint8_t *)CTP_CFG_GT911); // update the config
        gt911_write_bytes(GT_CHECK_REG, 2, temp);                                        // write config chksum
    }
    vTaskDelay(pdMS_TO_TICKS(10));
    temp[0] = 0X00;
    esp_err_t ret = gt911_write_bytes(GT_CTRL_REG, 1, temp); // end soft reset

    if(ret == ESP_OK) ESP_LOGI(TAG, "gt911 init ok");
    else ESP_LOGI(TAG, "gt911 init fail");
    return ret;
}

static esp_err_t gt911_get_touch_points_num(uint8_t *touch_points_num)
{
    uint8_t temp = 0;
    gt911_read_bytes(GT_GSTID_REG, 1, &temp);
    if (temp & 0x80) {
        *touch_points_num = temp & 0x0F;
        // ESP_LOGI(TAG, "reg=0x%X num=%d", temp, *touch_points_num);
        temp = 0;
        gt911_write_bytes(GT_GSTID_REG, 1, &temp);
    }else {
        *touch_points_num = 0;
    }

    return ESP_OK;
}

esp_err_t gt911_read_pos(uint8_t *touch_points_num, uint16_t *x, uint16_t *y)
{
    static uint8_t data[4];

    gt911_get_touch_points_num(touch_points_num);

    if (0 == *touch_points_num) {
    } else {
        gt911_read_bytes(GT_TP1_REG, 4, data);
        *x = ((data[1] & 0x0f) << 8) + data[0];
        *y = ((data[3] & 0x0f) << 8) + data[2];
        *x = 480 - *x;
    }

    return ESP_OK;
}



